<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-155991615-1");
    </script>

    <!-- my stuff -->
    <meta charset="utf-8">
    <title>ACT COVID-19 age profiles</title>
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- initial scripts -->
    <script src="./resources/d3.v6.min.js"></script>
    <link href="./resources/ageStyle.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
  </head>

  <body>
    <container id="container">
      <div id="header">
        <h1>OUTBREAK BY AGE</h1>
        <p>updated Thu, Aug 26, 2021</p>
      </div>
      <svg id="chart">
        <g id="chartGroup"></g>
        <g id="axisGroup">
          <g id="xFaxisGroup" class="axis"></g>
          <g id="xMaxisGroup" class="axis"></g>
          <g id="yAxisGroup" class="axis"></g>
        </g>
      </svg>
      <div id="keys">
        <div class="key cases">
          <div class="item">
            <div class="keyBox female"></div>
            <div>female cases</div>
          </div>
          <div class="item">
            <div class="keyBox male"></div>
            <div>male cases</div>
          </div>
          <div class="item">
            <div class="keyBox pop"></div>
            <div>population</div>
          </div>
        </div>
      </div>
      <div id="footer">
        The ages of <span></span> cases have not been published.
        Population estimates from June&nbsp;2020. Sources: ACT Health, ABS
      </div>
    </container>

    <script>
      // page elements
      top = d3.select("#top");
      header = d3.select("#header");
      chart = d3.select("#chart");
      chartGroup = d3.select("#chartGroup");
      xMaxisGroup = d3.select("#xMaxisGroup");
      xFaxisGroup = d3.select("#xFaxisGroup");
      yAxisGroup = d3.select("#yAxisGroup");
      footer = d3.select("#footer");

      // load LGA data
      d3.csv("./data/ageProfiles.csv?randomKey=" + Math.round(Math.random()*9000))
        .then(function(data) {

          // data
          ageData = data
            .map(function(d) {
              for (i = 1; i < 5; i++) {
                d[data.columns[i]] = +d[data.columns[i]];
              }
              return d;
            });
          population = d3.sum(ageData.map(function(d) {
            return d.pop_females + d.pop_males;
          }));
          unknown = 3;
          cases = d3.sum(ageData.map(function(d) {
            return d.males + d.females;
          })) + unknown;
          footer.select("span").text(unknown);
          maxScale = d3.max(ageData, function(d) {
            return d3.max([
              d.males / cases,
              d.females / cases,
              d.pop_males / population,
              d.pop_females / population
            ]);
          });

          // prepare chart
          xF = d3.scaleLinear()
            .domain([0, maxScale]);
          xM = d3.scaleLinear()
            .domain([0, maxScale]);
          y = d3.scaleBand()
            .domain(ageData.map(function(d) {
              return d.cohort;
            }))
            .padding(.05);
          xFaxis = d3.axisBottom(xF)
            .tickValues([.03, .06, .09, .12])
            .tickFormat(d3.format(".0%"))
            .tickPadding(10);
          xMaxis = d3.axisBottom(xM)
            .tickValues([.03, .06, .09, .12])
            .tickFormat(d3.format(".0%"))
            .tickPadding(10);
          yAxis = d3.axisLeft(y)
            .tickPadding(0)
            .tickSize(0);

          popMbars = chartGroup
            .selectAll(".bar.male.pop")
              .data(ageData)
            .enter().append("rect")
              .classed("bar male pop", true);
          popFbars = chartGroup
            .selectAll(".bar.female.pop")
              .data(ageData)
            .enter().append("rect")
              .classed("bar female pop", true);
          mBars = chartGroup
            .selectAll(".bar.male.case")
              .data(ageData)
            .enter().append("rect")
              .classed("bar male case", true);
          fBars = chartGroup
            .selectAll(".bar.female.case")
              .data(ageData)
            .enter().append("rect")
              .classed("bar female case", true);

          // fade in; calculate chart dimensions
          d3.timeout(function() {
            window.addEventListener("resize", resize);
            resize();
            chart.transition()
              .duration(500)
              .style("opacity", 1);
          }, 1000);
        });

      function resize() {
        chartDimensions = document.getElementById("chart").getBoundingClientRect();
        width = chartDimensions.width;
        height = chartDimensions.height;
        margin = width < 700 ? {
          top: 0,
          right: 0,
          bottom: 35,
          left: 0
        } : {
          top: 0,
          right: 0,
          bottom: 50,
          left: 0
        };
        xF.range([margin.left + (width - margin.left - margin.right) / 2, margin.left]);
        xM.range([margin.left + (width - margin.left - margin.right) / 2, width - margin.right]);
        y.range([margin.top, height - margin.bottom]);
        xFaxis.tickSizeInner(margin.top + margin.bottom - height);
        xMaxis.tickSizeInner(margin.top + margin.bottom - height);
        yAxisGroup.attr("transform", "translate(" + (margin.left + (width - margin.left - margin.right) / 2) + ", 0)")
          .call(yAxis);
        xFaxisGroup.attr("transform", "translate(0, " + (height - margin.bottom) + ")")
          .call(xFaxis);
        xMaxisGroup.attr("transform", "translate(0, " + (height - margin.bottom) + ")")
          .call(xMaxis);
        popMbars.attr("height", y.bandwidth())
          .attr("x", function(d) {
            return xM(0);
          })
          .attr("y", function(d) {
            return y(d.cohort);
          })
          .attr("width", function(d) {
            return xM(d.pop_males / population) - xM(0);
          });
        popFbars.attr("height", y.bandwidth())
          .attr("x", function(d) {
            return xF(d.pop_females / population);
          })
          .attr("y", function(d) {
            return y(d.cohort);
          })
          .attr("width", function(d) {
            return xF(0) - xF(d.pop_females / population);
          });
        mBars.attr("height", y.bandwidth() * .7)
          .attr("x", function(d) {
            return xM(0);
          })
          .attr("y", function(d) {
            return y(d.cohort) + y.bandwidth() * .15;
          })
          .attr("width", function(d) {
            return xM(d.males / cases) - xM(0);
          });
        fBars.attr("height", y.bandwidth() * .7)
          .attr("x", function(d) {
            return xF(d.females / cases);
          })
          .attr("y", function(d) {
            return y(d.cohort) + y.bandwidth() * .15;
          })
          .attr("width", function(d) {
            return xF(0) - xF(d.females / cases);
          });
      }
    </script>
  </body>
</html>
