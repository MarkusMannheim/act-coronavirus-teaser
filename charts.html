<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-155991615-1");
    </script>

    <!-- metaphysics -->
    <meta charset="utf-8">
    <title>ACT COVID-19 charts</title>
    <meta name="author" content="Markus Mannheim">
    <meta name="keywords" content="covid19, coronavirus, canberra, act, abc, updates, statistics, data">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- scripts -->
    <script src="./resources/d3.v7.min.js"></script>
    <link href="./resources/charts.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
  </head>

  <body>
    <div id="container">
      <div id="title"></div>
      <svg id="chart">
        <defs>
          <clipPath id="clipPath">
            <rect></rect>
          </clipPath>
        </defs>
        <g id="chartGroup"></g>
        <g id="axisGroup">
          <g id="xAxisGroup" class="axis"></g>
          <g id="yAxisGroup" class="axis"></g>
        </g>
      </svg>
      <div id="key"></div>
    </div>

    <script>
      // page elements
      container = d3.select("#container");
      title = d3.select("#title");
      key = d3.select("#key");
      chart = d3.select("#chart");
      chartGroup = d3.select("#chartGroup");
      clipPath = d3.select("#clipPath")
      xAxisGroup = d3.select("#xAxisGroup");
      yAxisGroup = d3.select("#yAxisGroup");
      loadTarget = document.querySelector("#chart");

      // chart type
      param = new URL(window.location.href).searchParams.get("field");

      // load data
      d3.csv("./data/caseData.csv")
        .then(function(data) {

          chartData = prepareData(data);
          startData = chartData
            .slice(0, 7);

          // fill fields
          title.text(titleText);
          keys = key
            .selectAll(".keyItem")
              .data(keyText)
            .enter().append("div")
              .attr("class", function(d, i) { return "keyItem layer" + (i + 1); });
          keys.append("div")
            .classed("keyBox", true);
          keys.append("div")
            .classed("keyLabel", true)
            .text(function(d) { return d; });

          // set up chart elements
          x = d3.scaleTime()
            .domain(d3.extent(startData, function(d) { return d.date; }));
          y = d3.scaleLinear();
          xAxis = d3.axisBottom(x)
            .ticks(4, "%b %-d")
            .tickSizeOuter(0)
            .tickPadding(5);
          yAxis = d3.axisLeft(y)
            .ticks(4, ",.0f")
            .tickSizeOuter(0)
            .tickPadding(5);
          if (param == "positivity") yAxis.ticks(4, ".1%");

          if (param == "new" || param == "positivity") {
            y.domain([0, d3.max(startData.map(function(d) { return d3.max([d.measure, d.trend]); }))]).nice();
            line = function(field) {
              return d3.line()
                .x(function(d) { return x(d.date); })
                .y(function(d) { return y(d[field]); })
                .curve(d3.curveBasis);
            }
            lineMeasure = chartGroup
              .append("path")
                .classed("line", true);
            if (chartData[0].trend) {
              lineTrend = chartGroup
                .append("path")
                  .classed("line trend", true);
            }

          } else if (param == "new_test" || param == "active" || param == "hospital") {
            y.domain([0, d3.max(startData.map(function(d) { return d.max; }))]).nice();
            stack = d3.stack()
              .keys(Object.keys(chartData[0]).slice(2).reverse());
            area = d3.area()
              .x(function(d) { return x(d.data.date); })
              .y1(function(d) { return y(d[1]); })
              .y0(function(d) { return y(d[0]); })
              .curve((param == "hospital" ? d3.curveStepBefore : d3.curveBasis));
            layers = chartGroup
              .selectAll(".layer")
                .data(stack(chartData))
              .enter().append("path")
                .attr("class", function(d) { return "layer " + d.key; });
          }

          // set up frame activation
          observer = new IntersectionObserver(loadFrame, {
            threshold: 1
          });
          loaded = false;
          observer.observe(loadTarget);

          // resizer
          window.addEventListener("resize", resizer);
        });

      function prepareData(data) {
        data = data
          .map(function(d) {
            for (i in Object.keys(d)) {
              if (Object.keys(d)[i] == "date") {
                d.date = new Date(d[Object.keys(d)[i]]);
              } else {
                d[Object.keys(d)[i]] = +d[Object.keys(d)[i]];
              }
            }

            // sort based on param
            if (param == "new") {
              titleText = "New infections per day";
              keyText = ["cases", "weekly average"];
              datum = {
                date: d.date,
                measure: d.new,
                trend: d.average
              };

            } else if (param == "positivity") {
              titleText = "Positive test rate";
              keyText = ["positivity", "weekly average"];
              datum = {
                date: d.date,
                measure: d.positivity,
                trend: d.positivity_trend
              };

            } else if (param == "new_test") {
              titleText = "How cases were detected";
              keyText = ["PCR (laboratory)", "RAT (home)"];
              datum = {
                date: d.date,
                max: d.new,
                layer1: d.pcr,
                layer2: d.rat
              };

            } else if (param == "active") {
              titleText = "Infected Canberrans";
              keyText = ["active cases"];
              datum = {
                date: d.date,
                max: d.active,
                layer1: d.active
              };

            } else if (param == "hospital") {
              titleText = "Hospitalised patients";
              keyText = ["hospitalised", "ICU", "ventilated"];
              datum = {
                date: d.date,
                max: d.hospitalised,
                layer1: (d.hospitalised - d["intensive care"] - d.ventilated),
                layer2: (d["intensive care"] - d.ventilated),
                layer3: d.ventilated
              };
            }

            return datum;
          })

          .filter(function(d) {
            return d.date > new Date("2021-11-30");
          });

        return data ;
      }

      function loadFrame(interactionObjects) {
        interactionObjects.map(function(object) {
          if (!loaded) {
            if (document.fonts.status == "loaded") {
              if (object.isIntersecting) {
                resizer();
              }

            } else {
              document.fonts.onloadingdone = function() {
                resizer();
              }
            }
          }
        });
      }

      function drawChart() {
        d3.selectAll("#key, #chartGroup")
          .transition()
            .duration(1000)
            .style("opacity", 1);

        x.range([margin.left, chartWidth - margin.right]);
        y.range([chartHeight - margin.bottom, margin.top]);

        clipPath.select("rect")
          .attr("x", margin.left)
          .attr("y", 0)
          .attr("width", chartWidth - margin.left - margin.right)
          .attr("height", chartHeight);

        if (param == "new" || param == "positivity") {
          lineMeasure.attr("d", line("measure")(chartData.filter(function(d) { return d.measure; })));
          if (lineTrend) lineTrend.attr("d", line("trend")(chartData.filter(function(d) { return d.trend; })));

        } else if (param == "new_test" ||  param == "active" || param == "hospital") {
          layers.attr("d", function(d) { return area(d); });
        }

        xAxis.tickSizeInner([margin.top + margin.bottom - chartHeight]);
        yAxis.tickSizeInner([margin.left + margin.right - chartWidth]);

        xAxisGroup.attr("transform", "translate(0, " + (chartHeight - margin.bottom) + ")")
          .call(xAxis);
        yAxisGroup.attr("transform", "translate(" + margin.left + ", 0)")
          .call(yAxis);

        d3.timeout(animate, 1500);
      }

      function animate() {
        loop = 100;
        i = 6;

        animateFrame = d3.interval(function() {
          i++;
          if (i < chartData.length) {
            currentData = chartData.slice(0, i);

            x.domain(d3.extent(currentData, function(d) { return d.date; }));

            if (param == "new" || param == "positivity") {
              y.domain([0, d3.max(currentData.map(function(d) { return d3.max([d.measure, d.trend]); }))]);
              if (param == "positivity" && y.domain()[1] >= .05) yAxis.ticks(4, ".0%");
              lineMeasure.transition()
                .duration(loop)
                .ease(d3.easeLinear)
                .attr("d", line("measure")(chartData.filter(function(d) { return d.measure; })));
              if (lineTrend) {
                lineTrend.transition()
                  .duration(loop)
                  .ease(d3.easeLinear)
                  .attr("d", line("trend")(chartData.filter(function(d) { return d.trend; })));
              }

            } else if (param == "new_test" || param == "active" || param == "hospital") {
              y.domain([0, d3.max(currentData.map(function(d) { return d.max; }))]);
              layers.transition()
                .duration(loop)
                .ease(d3.easeLinear)
                .attr("d", function(d) { return area(d); });
            }

            xAxisGroup.transition()
              .duration(loop)
              .ease(d3.easeLinear)
              .call(xAxis);
            yAxisGroup.transition()
              .duration(loop)
              .ease(d3.easeLinear)
              .call(yAxis);

          } else {
            animateFrame.stop();
          }
        }, loop);
      }

      function resizer() {
        loaded = true;

        dimensions = document.getElementById("chart").getBoundingClientRect();
        chartWidth = dimensions.width;
        chartHeight = dimensions.height;

        margin = { top: 5, right: 5, bottom: 20, left: 40 };

        drawChart();
      }

    </script>
  </body>
</html>
