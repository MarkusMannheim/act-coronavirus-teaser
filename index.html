<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-155991615-1");
    </script>

    <!-- my stuff -->
    <meta charset="utf-8">
    <title>ACT COVID-19 snapshot</title>
    <meta name="author" content="Markus Mannheim">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- initial scripts -->
    <script src="./resources/d3.v6.min.js"></script>
    <script src="./resources/topojson.v3.min.js"></script>
    <link href="./resources/style.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
  </head>

  <body>
    <container id="container">
      <div id="top">
        <div id="topContainer">
          <div id="header">
            <h1>ACT COVID-19 SNAPSHOT</h1>
            <p>last updated <span id="date"></span>*</p>
          </div>
          <div id="counts">
            <div id="newCases" class="count">
              <div class="box"></div>
              <div>new cases</div>
            </div>
            <div id="activeCases" class="count">
              <div class="box"></div>
              <div>active cases</div>
            </div>
            <div id="daysSince" class="count">
              <div class="box"></div>
              <div>days since last case</div>
            </div>
          </div>
          <hr>
          <div id="chartHead">
            Vaccinations among Canberrans aged 16+:
          </div>
        </div>
        <svg id="icon"></svg>
      </div>
      <svg id="chart">
        <g id="chartGroup"></g>
        <g id="axisGroup">
          <g id="xAxisGroup" class="axis"></g>
          <g id="yAxisGroup" class="axis"></g>
        </g>
      </svg>
      <div id="keys">
        <div class="key one">
          <div></div>
          <div>at least one dose</div>
        </div>
        <div class="key two">
          <div></div>
          <div>two doses</div>
        </div>
      </div>
      <div id="footer">
        Note: Vaccination reports usually have a two-day lag.
        The ABC has smoothed some past vaccination counts to address erroneous and missing government data.
        Population based on June&#160;2020 estimates.
        Sources: ACT Health, Commonwealth Department of Health, covidlive.com.au, ABS
      </div>
    </container>

    <script>
      // page elements
      top = d3.select("#top");
      topContainer = d3.select("#topContainer");
      header = d3.select("#header");
      date = d3.select("#date");
      counts = d3.select("#counts");
      newCases = d3.select("#newCases");
      activeCases = d3.select("#activeCases");
      daysSince = d3.select("#daysSince");
      counts = d3.select("#counts");
      icon = d3.select("#icon");
      chartHead = d3.select("#chartHead");
      chart = d3.select("#chart");
      chartGroup = d3.select("#chartGroup");
      xAxisGroup = d3.select("#xAxisGroup");
      yAxisGroup = d3.select("#yAxisGroup");
      keys = d3.select("#keys");
      footer = d3.select("#footer");

      // load LGA data
      Promise.all([
        d3.csv("./data/data.csv"),
        d3.json("./data/act.topojson"),
      ])
        .then(function(data) {

          // data
          covidData = data[0]
            .map(function(d) {
              d.date = d3.timeParse("%Y-%m-%d")(d.date);
              let keys = Object.keys(d);
              for (i = 1; i < keys.length; i++) {
                d[keys[i]] = +d[keys[i]];
              }
              return d;
            });

          // draw map
          mapData = topojson.feature(data[1], data[1].objects.areas);
          projection = d3.geoConicEqualArea()
            .parallels([-26.293056, -44.293056])
            .rotate([-149.126944, 0]);
          path = d3.geoPath()
            .projection(projection);
          map = icon
            .append("path")
              .attr("id", "map");

          // update date
          date.text(d3.timeFormat("%b %-d, %Y")(covidData[covidData.length - 1].date));

          // update counts
          newCases.select(".box")
            .text(covidData[covidData.length - 1].new);
          activeCases.select(".box")
            .text(covidData[covidData.length - 1].total - covidData[covidData.length - 1].dead - covidData[covidData.length - 1].recovered);
          lastDay = function() {
            let day=0;
            while (true) {
              if (covidData.map(d => d.new)[covidData.length - 1 - day] > 0) {
                break;
              } else {
                day = day + 1;
              }
            }
            return day;
          }
          daysSince.select(".box")
            .text(lastDay);

          // chartData
          chartData = covidData
            .filter(function(d) {
              return d.one > 0;
            })
            .map(function(d) {
              return {
                date: d.date,
                one: d.one,
                two: d.two
              };
            });
          stackedData = d3.stack()
            .keys(["two", "one"])
            (chartData);
          area = d3.area()
            .x(function(d) { return x(d.data.date); })
            .y1(function(d) { return y(d[1]); })
            .y0(function(d) { return y(d[0]); });

          // prepare chart
          margin = {
            top: 10,
            right: 5,
            bottom: 30,
            left: 30
          };
          x = d3.scaleTime()
            .domain(d3.extent(chartData.map(function(d) {
              return d.date;
            })));
          y = d3.scaleLinear()
            .domain(d3.extent(chartData.map(function(d) {
              return d.one + d.two;
            }))).nice();
          xAxis = d3.axisBottom(x)
            .tickSizeOuter(0)
            .ticks(4, "%b");
          yAxis = d3.axisLeft(y)
            .tickSizeOuter(0)
            .ticks(3, ".0%")
            .tickPadding(5);
          areas = chartGroup
            .selectAll(".area")
              .data(stackedData)
            .enter().append("path")
              .attr("class", function(d) {
                return "area " + d.key;
              });
          keys.select(".key.one div")
            .text(d3.format(".1%")(chartData[chartData.length - 1].one + chartData[chartData.length - 1].two));
          keys.select(".key.two div")
            .text(d3.format(".1%")(chartData[chartData.length - 1].two));

          // fade in; calculate chart dimensions
          d3.timeout(function() {
            window.addEventListener("resize", resize);
            resize();
            d3.selectAll("#counts, #chart, #icon, #chartHead, #keys")
              .transition()
                .duration(500)
                .style("opacity", 1);
          }, 1000);
        });

      function resize() {
        chartDimensions = document.getElementById("chart").getBoundingClientRect();
        mapDimensions = document.getElementById("icon").getBoundingClientRect();
        width = chartDimensions.width;
        height = chartDimensions.height;
        x.range([margin.left, width - margin.right]);
        y.range([height - margin.bottom, margin.top]);
        yAxis.tickSizeInner(margin.left + margin.right - width);
        xAxisGroup.attr("transform", "translate(0, " + (height - margin.bottom) + ")")
          .call(xAxis);
        yAxisGroup.attr("transform", "translate(" + (margin.left) + ", 0)")
          .call(yAxis);
        keys.style("left", (margin.left + 16) + "px")
          .style("top", (chartDimensions.top + margin.top) + "px");
        areas.attr("d", area);
        icon.style("width", (mapDimensions.height * 118 / 150) + "px");
        projection.fitHeight(mapDimensions.height - 8, mapData);
        map.attr("d", path(mapData));
      }
    </script>
  </body>
</html>
