<!DOCTYPE html>
<html>
  <head>
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155991615-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag("js", new Date());
      gtag("config", "UA-155991615-1");
    </script>

    <!-- metaphysics -->
    <meta charset="utf-8">
    <title>ACT COVID-19 update</title>
    <meta name="author" content="Markus Mannheim">
    <meta name="keywords" content="covid19, coronavirus, canberra, act, abc, updates, statistics, data">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- stuff for scrapers -->
    <meta property="og:title" content="ACT COVID-19 updates">
    <meta property="og:description" content="Visualising the disease and vaccine progress in Canberra.">
    <meta property="og:image" content="https://markusmannheim.github.io/act-coronavirus-teaser/resources/graph.jpg">
    <meta property="og:url" content="https://markusmannheim.github.io/act-coronavirus-teaser/">
    <meta property="og:type" content="website">
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:site" content="@MarkusMannheim">
    <meta property="twitter:creator" content="@MarkusMannheim">

    <!-- scripts -->
    <script src="./resources/d3.v6.min.js"></script>
    <link href="./resources/style.css" rel="stylesheet">
    <link href="./resources/abcLogo64.png" rel="icon">
  </head>

  <body>
    <div id="container">
      <div id="header">ACT COVID-19 UPDATE</div>
      <div id="selector">
        <div class="choice selected" id="choiceCases" onclick="select(this, 'cases')">cases</div>
        <div class="choice" id="choiceOutcomes" onclick="select(this, 'outcomes')">outcomes</div>
        <div class="choice" id="choiceVaccinations" onclick="select(this, 'vaccinations')">vaccinations</div>
      </div>
      <svg id="chart">
        <g id="chartGroup"></g>
        <g id="axisGroup">
          <g id="xAxisGroup" class="axis"></g>
          <g id="yAxisGroup" class="axis"></g>
        </g>
      </svg>
    </div>
    <div id="tip"></div>

    <script>
      // page elements
      container = d3.select("#container");
      chart = d3.select("#chart");
      chartGroup = d3.select("#chartGroup");
      choices = d3.selectAll(".choice");
      axisGroup = d3.select("#axisGroup");
      xAxisGroup = d3.select("#xAxisGroup");
      yAxisGroup = d3.select("#yAxisGroup");
      tip = d3.select("#tip");
      selection = "cases";

      // load LGA data
      Promise.all([
        d3.csv("./data/caseData.csv"),
        d3.csv("./data/vaxData.csv")
      ])
        .then(function(data) {

          // data
          caseData = data[0]
            .map(function(d) {
              let keys = Object.keys(d);
              for (key in keys) {
                if (keys[key] == "date") {
                  d.date = new Date(d.date);
                } else {
                  d[keys[key]] = +d[keys[key]];
                }
              }
              return d;
            });
          caseData = caseData
            .map(function(d) {
              // d["intensive care"] = d["intensive care"] - d.ventilated;
              d.hospitalised = d.hospitalised - d["intensive care"]; // - d.ventilated;
              d.active = d.active - d.hospitalised - d["intensive care"]; // - d.ventilated;
              return d;
            });

          vaxData = data[1]
            .map(function(d) {
              vaxUpdate = new Date(d.date);
              return {
                jurisdiction: d.jurisdiction,
                first: +d.first_percent,
                second: +d.second_percent,
                gap: +d.first_percent - +d.second_percent
              };
            });
          ausData = vaxData
            .filter(function(d) {
              return d.jurisdiction == "AUS";
            })[0];
          vaxData = vaxData
            .filter(function(d) {
              return d.jurisdiction !== "AUS";
            })
            .sort(function(a, b) {
              return d3.ascending(a.second, b.second);
            });
          vaxData.unshift(ausData);

          // fade in; calculate chart dimensions
          d3.timeout(function() {
            window.addEventListener("resize", prepareChart);
            prepareChart();
            chart.transition()
              .duration(500)
              .style("opacity", 1);
          }, 1000);
        });

      function select(element, choice) {
        choices.classed("selected", false);
        element.classList.toggle("selected");
        selection = choice;
        prepareChart();
      }

      function prepareChart() {
        d3.selectAll("#chartGroup *, #xAxisGroup *, #yAxisGroup *, #footer, #notes")
          .remove();
        tip.style("opacity", 0);

        if (selection == "outcomes") {
          keyData = ["dead", "intensive care", "hospitalised", "active"]; // "ventilated",
          x = d3.scaleTime()
            .domain(d3.extent(caseData, function(d) { return d.date; }));
          y = d3.scaleLinear()
            .domain(d3.extent(caseData, function(d) {
              return d.active + d.dead + d["intensive care"] + d.hospitalised; // + d.ventilated;
            }));
          xAxis = d3.axisBottom(x)
            .tickSize(0);
          yAxis = d3.axisLeft(y)
            .ticks(4)
            .tickSizeOuter(0);
          footer = container
            .append("div")
              .attr("id", "footer");
          keys = footer
            .selectAll(".key")
              .data(keyData)
            .enter().append("div")
              .attr("class", function(d) {
                if (d == "intensive care") {
                  return "key icu";
                } else {
                  return "key " + d;
                }
              })
              .text(function(d) {
                if (d == "dead") {
                  return "deaths";
                } else if (d == "active") {
                  return "active cases";
                } else {
                  return d;
                }
              });
          notes = container
            .append("div")
              .attr("id", "notes")
              .text("The ACT outbreak has infected at least "
                + d3.format(",.0f")(caseData.slice(-1)[0].total) + " people "
                + "and is linked with "
                + d3.format(",.0f")(d3.sum(caseData.map(d => d.dead))) + " deaths.");

        } else if (selection == "cases") {
          x = d3.scaleBand()
            .domain(caseData.map(function(d) { return d.date; }))
            .padding(0);
          x2 = d3.scaleTime()
            .domain(d3.extent(caseData, function(d) { return d.date; }));
          y = d3.scaleLinear()
            .domain([0, d3.max(caseData, function(d) {
              return d3.max([d.new, d.average]);
            })]);
          xAxis = d3.axisBottom(x2)
            .tickSize(0);
          yAxis = d3.axisLeft(y)
            .ticks(4)
            .tickSizeOuter(0);
          footer = container
            .append("div")
              .attr("id", "footer");
          keys = footer
            .selectAll(".key")
              .data(["cases", "average"])
            .enter().append("div")
              .attr("class", function(d) {
                return "key " + d;
              })
              .text(function(d) {
                if (d == "cases") {
                  return "daily cases";
                } else {
                  return "seven-day average";
                }
              });
          notes = container
            .append("div")
              .attr("id", "notes")
              .text("These data were last updated on "
                + d3.timeFormat("%A, %B %-d, %Y")(caseData.slice(-1)[0].date) + ".");

        } else {
          x = d3.scaleLinear()
            .domain([0, 1]);
          y = d3.scaleBand()
            .domain(vaxData.map(function(d) { return d.jurisdiction; }))
            .paddingOuter(0)
            .paddingInner(.1);
          xAxis = d3.axisBottom(x)
            .tickValues([.2, .4, .6, .8])
            .tickFormat(d3.format(".0%"))
            .tickSizeOuter(0);
          yAxis = d3.axisRight(y)
            .tickSizeOuter(0);
          footer = container
            .append("div")
              .attr("id", "footer");
          keys = footer
            .selectAll(".key")
              .data(["second", "first"])
            .enter().append("div")
              .attr("class", function(d) {
                return d + " key";
              })
              .text(function(d) {
                if (d == "second") {
                  return "fully vaccinated";
                } else {
                  return "one dose only";
                }
              });
          notes = container
            .append("div")
              .attr("id", "notes")
              .text("Note: Vaccination rates are based on the entire population, "
                + "using the Australian Bureau of Statistics' June 2021 "
                + "population estimates. Data last updated on "
                + d3.timeFormat("%B %-d, %Y")(vaxUpdate) + ".");
        }

        resize();
      }

      function drawChart() {
        if (selection == "vaccinations") {
          margin = {
            top: 8,
            right: 0,
            bottom: (width < 500 ? 16 : 24),
            left: 0
          };
          xAxis.tickSizeInner(margin.top + margin.bottom - height)
          if (width < 500) {
            xAxis.ticks(4, "%b")
              .tickPadding(5);
          } else {
            xAxis.ticks(5, "%b %-d")
              .tickPadding(10);
          }
          vaxBars = chartGroup
            .selectAll(".vaxBar")
              .data(vaxData)
            .enter().append("g")
              .classed("vaxBar", true);
          backgroundBars = vaxBars
            .append("rect")
              .classed("backgroundBar", true);
          firstBars = vaxBars
            .append("rect")
              .classed("firstBar", true);
          secondBars = vaxBars
            .append("rect")
              .classed("secondBar", true);
          firstLabels = vaxBars
            .append("text")
              .classed("firstLabel", true)
              .classed("barLabel", true)
              .text(function(d) { return d3.format(".1%")(d.first);});
          secondLabels = vaxBars
            .append("text")
              .classed("secondLabel", true)
              .classed("barLabel", true)
              .text(function(d) { return d3.format(".1%")(d.second);});

        } else if (selection == "cases") {
          margin = {
            top: 8,
            right: 8,
            bottom: (width < 500 ? 16 : 24),
            left: (width > 700 ? 32 : 24)
          };
          yAxis.tickSizeInner(margin.left + margin.right - width);
          xAxis.ticks(4, "%b");
          if (width < 500) {
            xAxis.tickPadding(5);
          } else {
            xAxis.tickPadding(10);
          }
          barGroups = chartGroup
            .selectAll(".barGroup")
              .data(caseData)
            .enter().append("g")
              .classed("barGroup", true);
          touchBars = barGroups
            .append("rect")
              .classed("touchBar", true)
              .on("mouseover", mouseOverCaseBar)
              .on("mouseout", mouseOutCaseBar);
          caseBars = barGroups
            .append("rect")
              .classed("caseBar", true);
          line = d3.line()
            .x(function(d) { return x2(d.date); })
            .y(function(d) { return y(d.average); })
            .curve(d3.curveNatural);
          averageLine = chartGroup
            .append("path")
              .attr("id", "averageLine");

        } else {
          margin = {
            top: 8,
            right: 8,
            bottom: (width < 500 ? 16 : 24),
            left: (width > 700 ? 40 : 32)
          };
          yAxis.tickSizeInner(margin.left + margin.right - width);
          xAxis.ticks(4, "%b");
          if (width < 500) {
            xAxis.tickPadding(5);
          } else {
            xAxis.tickPadding(10);
          }
          stack = d3.stack()
            .keys(keyData)
            (caseData);
          area = d3.area()
            .x(function(d) { return x(d.data.date); })
            .y0(function(d) { return y(d[0]); })
            .y1(function(d) { return y(d[1]); })
            .curve(d3.curveNatural);
          outcomes = chartGroup
            .selectAll(".outcome")
              .data(stack)
            .enter().append("path")
              .attr("class", function(d) {
                if (d.key == "intensive care") {
                  return "outcome icu";
                } else {
                  return "outcome " + d.key;
                }
              });
          outcomeMarkers = chartGroup
            .selectAll(".outcomeMarker")
              .data(caseData)
            .enter().append("g")
              .classed("outcomeMarker", true);
          outcomeCells = outcomeMarkers
            .append("path")
              .classed("outcomeCell", true)
              .on("mouseover", mouseOverOutcome)
              .on("mouseout", mouseOutOutcome);
          outcomeLines = outcomeMarkers
            .append("line")
              .classed("outcomeLine", true);
          outcomePoints = outcomeMarkers
            .append("circle")
              .classed("outcomePoint", true)
              .attr("r", 5);
        }
      }

      function resize() {
        dimensions = document.getElementById("chart").getBoundingClientRect();
        width = dimensions.width;
        height = dimensions.height;
        drawChart();

        x.range([margin.left, width - margin.right]);
        y.range([height - margin.bottom, margin.top]);
        if (selection == "cases") {
          x2.range([margin.left + x.bandwidth() / 2, width - margin.right - x.bandwidth() / 2]);
        }

        xAxisGroup.attr("transform", "translate(0, " + (height - margin.bottom) + ")")
          .call(xAxis);
        yAxisGroup.attr("transform", "translate(" + margin.left + ", 0)")
          .call(yAxis);

        if (selection == "outcomes") {
          delaunay = d3.Delaunay
            .from(caseData.map(function(d) {
              return [x(d.date), y(d.dead + d["intensive care"] + d.hospitalised + d.active)]; // d.ventilated +
            }));
          voronoi = delaunay
            .voronoi([0, 0, width, height]);
          outcomePoints.attr("cx", function(d) {
              return x(d.date);
            })
            .attr("cy", function(d) {
              return y(d.dead + d["intensive care"] + d.hospitalised + d.active); // d.ventilated +
            });
          outcomeLines.attr("x1", function(d) { return x(d.date); })
            .attr("x2", function(d) { return x(d.date); })
            .attr("y1", function(d) { return y(d.dead + d["intensive care"] + d.hospitalised + d.active); }) // d.ventilated +
            .attr("y2", y(0));
          outcomeCells.attr("d", function(d, i) {
              return voronoi.renderCell(i);
            });
          outcomes.attr("d", area);

        } else if (selection == "cases") {
          barGroups.attr("transform", function(d) {
            return "translate(" + x(d.date) + ", 0)";
          });
          touchBars.attr("width", x.bandwidth())
            .attr("x", 0)
            .attr("y", margin.top)
            .attr("height", height - margin.top - margin.bottom);
          caseBars.attr("width", x.bandwidth())
            .attr("x", 0)
            .attr("y", function(d) { return y(d.new); })
            .attr("height", function(d) { return y(0) - y(d.new); });
          averageLine.attr("d", line(caseData));

        } else {
          vaxBars.attr("transform", function(d) {
            return "translate(0, " + y(d.jurisdiction) + ")";
          });
          backgroundBars.attr("width", width - margin.right - margin.left)
            .attr("height", y.bandwidth())
            .attr("x", margin.left)
            .attr("y", 0);
          secondBars.attr("width", function(d) { return x(d.second) - margin.left; })
            .attr("height", y.bandwidth())
            .attr("x", margin.left)
            .attr("y", 0);
          firstBars.attr("width", function(d) { return x(d.first) - x(d.second); })
            .attr("height", y.bandwidth())
            .attr("x", function(d) { return x(d.second); })
            .attr("y", 0);
          yAxisGroup.selectAll(".tick text")
            .classed("vax", true);
          firstLabels.attr("x", function(d) { return x(d.first) - (width < 500 ? 4 : 8); })
            .attr("y", y.bandwidth() / 2);
          secondLabels.attr("x", function(d) {
              let firstBorder = +this.parentNode.querySelector(".firstLabel").getBBox().x;
              if (firstBorder < x(d.second)) {
                console.log(firstBorder, x(d.second));
                return firstBorder - 8;
              } else {
                return x(d.second) - 8;
              }
            })
            .attr("y", y.bandwidth() / 2);
        }
      }

      function mouseOverCaseBar(event, d) {
        this.parentNode.classList.toggle("selected");
        tip.style("top", "0px")
          .style("left", "0px")
          .html("<h1> " + d3.timeFormat("%a, %b %-d")(d.date )+ "</h1>"
            + "<p>new cases: <span class='cases'>" + d.new + "</span></p>"
            + "<p>rolling average: <span class='average'>" + d3.format(".1f")(d.average) + "</span></p>");
        let tipDim = tip.node().getBoundingClientRect();
        tip.style("top", function() {
            if (y(d.average) + tipDim.height + 20 > height - margin.bottom) {
              return (dimensions.top + height - margin.bottom - 20 - tipDim.height) + "px";
            } else {
              return (dimensions.top + y(d.average) + 10) + "px";
            }
          })
          .style("left", function() {
              if (x(d.date) + tipDim.width / 2 + 10 > width - margin.right) {
                return (dimensions.left + width - margin.right - tipDim.width - 20) + "px";
              } else if (x(d.date) - tipDim.width / 2 - 10 < margin.left) {
                return (dimensions.left + margin.left + 10) + "px";
              } else {
                return (dimensions.left + x(d.date) + 10 - tipDim.width / 2) + "px";
              }
            })
          .style("opacity", 1);
      }

      function mouseOutCaseBar() {
        this.parentNode.classList.toggle("selected");
        tip.style("opacity", 0);
      }

      function mouseOverOutcome(event, d) {
        this.parentNode.classList.toggle("selected");
        tip.style("top", "0px")
          .style("left", "0px")
          .html("<h1> " + d3.timeFormat("%a, %b %-d")(d.date )+ "</h1>"
            + "<p>active cases: <span class='active'>" + (d.active + d.hospitalised + d["intensive care"]) + "</span></p>" //  + d.ventilated
            + "<p>hospitalised: <span class='hospitalised'>" + (d.hospitalised + d["intensive care"]) + "</span></p>" //  + d.ventilated
            + "<p>intensive care: <span class='icu'>" + d["intensive care"] + "</span></p>" //  + d.ventilated)
            // + "<p>ventilated: <span class='ventilated'>" + d.ventilated + "</span></p>"
            + "<p>deaths: <span class='dead'>" + d.dead + "</span></p>");
        let tipDim = tip.node().getBoundingClientRect();
        tip.style("top", function() {
            if (y(d.dead + d["intensive care"] + d.hospitalised + d.active) + tipDim.height + 20 > height - margin.bottom) { // + d.ventilated
              return (dimensions.top + height - margin.bottom - 20 - tipDim.height) + "px";
            } else {
              return (dimensions.top + y(d.dead + d["intensive care"] + d.hospitalised + d.active) + 10) + "px"; //  + d.ventilated
            }
          })
          .style("left", function() {
            if (x(d.date) + tipDim.width / 2 + 10 > width - margin.right) {
              return (dimensions.left + width - margin.right - tipDim.width - 20) + "px";
            } else if (x(d.date) - tipDim.width / 2 - 10 < margin.left) {
              return (dimensions.left + margin.left + 10) + "px";
            } else {
              return (dimensions.left + x(d.date) + 10 - tipDim.width / 2) + "px";
            }
          })
          .style("opacity", 1);
      }

      function mouseOutOutcome() {
        this.parentNode.classList.toggle("selected");
        tip.style("opacity", 0);
      }
    </script>
  </body>
</html>
